---
title: "**An Evaluation of the Causal Effect of a Promotion Campaign on Software Usage**"
subtitle: |
  | Febriany Lete
  | Maysen Pagan
date: April 2024
  
output: 
  bookdown::pdf_document2:
    toc: false
    number_sections: true
    linkcolor: blue
urlcolor: blue
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo = FALSE}
#libraries
suppressPackageStartupMessages(library(tidyverse))
library(boot)
library(DescTools)
suppressPackageStartupMessages(library(reshape2))
suppressPackageStartupMessages(library(kableExtra))
#read data
promo <- read.csv("promotion.csv")
```

# Introduction

# Exploratory Data Analysis

Before performing any causal analysis, we first explore the data for any missing values or outliers. There are no missing values in our data set, however, from a histogram of our response variable, we can see there exists one value that is negative. Since it is unknown if the revenue from this customer was input incorrectly and there is only one observation where the revenue is less than 0, we will remove this customer from our data set.

```{r, echo = FALSE}
hist(promo$Revenue, breaks = 15, main = "Figure 1. Histogram of Revenue Response Variable", xlab = "Revenue")

promo <- promo %>% filter(Revenue>0)
```

Next, we look at a correlation matrix of our quantitative variables. 

```{r, echo = FALSE}
cormat <- round(cor(promo[,c(5,6,7,8,11)]),2)
cormat
```
From this matrix, we can see a strong linear association of 0.95 between the number of PCs a customer has and the number of employees a customer has. Similarly, there is a large correlation of 0.88 between the size of the customer, given by their yearly total revenue, and the dollars spent on IT purchases by the customer. As a result, we choose to omit the dollars spend on IT purchases and the number of PCs the customer has from further analysis. 

# Methods and Analysis

## Assumptions

We then consider the three main identification assumptions to identify our average treatment effect: Positivity, Consistency, and Conditional Exchangeability.

### Positivity

For the Positivity assumption, we observed the covariate balance plots for each of our covariates, comparing the distribution of the values between the treatment and control. These plots can be viewed in the Appendix. All plots show the pattern of an equal distribution of covariate values between those customers who received the discount and those who did not. For example, the first covariate balance plot for the employee count variable displays a skewed right distribution with the count ranging from 0 to about 500 employees both for customers who received a discount and customers who did not receive a discount. This demonstrates that for given values of each of the covariates, the probability of receiving the treatment and control are both non-zero. Therefore, 

$0<p(A = a|X)<1,\:a\in\{0,1\}$

### Consistency

We will also perform our causal analysis under the Consistency assumption which states that a customer's potential outcome under the observed treatment assignment is equal to the observed outcome for that customer. Therefore,

If $A_i = a,$ then $Y_i = Y_i^{(a)}$

### Conditional Exchangeability

For the Conditional Exchangeability assumption, we thought of possible variables that could be a confounder of the treatment-outcome relation. We believe that the size of the customer could be this confounder. The startup company might tend to give discounts to larger companies either to keep their loyalty or prevent them from purchasing from their competitors. In this sense, the size of the customer directly affects the treatment assignment. Additionally, the size of the customer may also directly affect the outcome because, for example, larger customers will most likely purchase more software than smaller customers and therefore bring in more revenue for the company.

However, this size of the customer confounder can be observed in our data set through variables such as the number of employees the customer has or the binary variable that indicates if the customer has global offices. Larger businesses tend to have more employees as well as global offices. Since this confounder can be observed in our data set, we continue with the assumption of Conditional Exchangeability which states

$\{Y^{(0)}, Y^{(1)}\} \newcommand{\indep}{\perp \!\!\! \perp} A|X$

## Estimation

Under the above assumptions, which are known as the three main identification assumptions, our parameter of interest, the average treatment effect (ATE), can be identified and then estimated using the Outcome Regression (OR) estimator, the Inverse Probability Weighting (IPW) estimator, the Hajek estimator as well as the Doubly Robust (DR) estimator.

We first use the simplest estimator for the ATE which is the (OR) Estimator. We also choose to estimate $\hat{\mu}$ for the OR function using linear regression with ordinary least squares estimator with $(1, A, X)$ as predictors. We then use non-parametric bootstrap to estimate the standard error and obtain confidence intervals for the OR estimator.

Rather than modeling the outcome mechanism, we also model the treatment assignment mechanism using propensity score in the IPW Estimator. This method is often used when partial information is available about the treatment assignment. In campaign problem, we are not certain of how the company chose which customers to provide discounts to. Non-parametric bootstrap was also used to estimate standard error and obtain confidence intervals.

The IPW approach, however, is not invariant to location transformation of the outcome and also is not stable leading to high variance. Therefore, we also calculate the ATE using the Hajek estimator which is invariant to location transformation of the outcome and is more stable (although this means it also has increased bias). Non-parametric bootstrap was used to estimate standard error and obtain confidence intervals.

The OR function in the OR Estimator represents the outcome mechanism while the propensity score in the IPW and Hajek Estimators represents the treatment assignment mechanism. We also estimate the ATE using the DR Estimator which combines both information and is unbiased if either the OR function or the propensity score is correctly specified. Similar to the previous estimators, non-parametric bootstrap was used to estimate standard error and obtain confidence intervals.

The propensity score was estimated using logistic regression with an order 1 polynomial. For each of the covariates, the estimated propensity scores were used to calculate $\frac{1}{n}\sum_{i=1}^{n}\{\frac{A_i}{\hat{\pi}(x_i)}-1\}\hspace{0.1cm}X_{i_{p}}$ for $p$ = 1,2,...,6 for 6 predictors. Bootstrap was used to calculate 1000 of these values for each covariate and 95% confidence intervals were produced. The results are shown in the table below. From this table, we can see that the value 0 falls in every confidence interval which suggests that my estimator of the propensity score satisfies the weighted balancing property for each of the covariates.

Table 2 displays the ATE estimates, bootstrap standard errors, and bootstrap confidence intervals using the four methods above. 

From this table, we can see that all of the 95% bootstrap confidence intervals do not contain zero suggesting that there is a positive causal effect between giving a customer a discount and the revenue received from that customer. We focus on the DR estimator because only one of the OR function or propensity score needs to be correctly specified for the estimator to be unbiased. We observe that the ATE is about 5,500 which means that on average, customers who received the discount would give the company $5,500 more in revenue than those who did not receive the discount.

## Sensitivity Analysis

We then performed sensitivity analysis to observe the extent to which the Conditional Exchangeability assumption might be violated. We chose our sensitivity parameters to range from $\frac{1}{2}$ to 2 and Figure 1 is a heatmap of the calculated effects with certain combinations of these parameters. We can see from the bottom right corner of the heatmap that the signs of our ATEs are sensitive only for larger sensitivity parameters. This suggests that when customers who receive a discount tend to bring in more revenue (which means the sensitivity parameters are larger than 1), then our results are sensitive. On the other hand, for customers who receive a discount and tend to bring in less revenue, our results are not sensitive and we can conclude that there is a positive causal effect.

# Conclusion



\newpage
# Appendix
```{r, echo = FALSE, fig.height=8}
#covariate balance check
treatment <- promo %>% filter(Discount==1)
control <- promo %>% filter(Discount==0)
par(mfrow=c(3,2))
#number of employees
hist(treatment$Employee.Count, main = "Employee Count Under Treatment", xlab = "Employee Count")
hist(control$Employee.Count, main = "Employee Count Under Control", xlab = "Employee Count")
#customer's size given by their yearly total revenue
hist(log(treatment$Size), main = "Customer Size Under Treatment", xlab = "Customer Size")
hist(log(control$Size), main = "Customer Size Under Control", xlab = "Customer Size")
#whether the customer's business is commercial
hist(treatment$Commercial.Flag, main = "Commercial Flag Under Treatment", xlab = "Commercial Flag")
hist(control$Commercial.Flag, main = "Commercial Flag Under Control", xlab = "Commercial Flag")
```

```{r, echo = FALSE, fig.height=8}
#whether the customer is a Small Medium Corporation
par(mfrow=c(3,2))
hist(treatment$SMC.Flag, main = "Small Medium Corporation Flag Under Treatment", xlab = "Small Medium Corporation Flag")
hist(control$SMC.Flag, main = "Small Medium Corporation Flag Under Control", xlab = "Small Medium Corporation Flag")
#whether the customer is a large consumer in their industry
hist(treatment$Major.Flag, main = "Large Consumer Flag Under Treatment", xlab = "Large Consumer Flag")
hist(control$Major.Flag, main = "Large Consumer Flag Under Control", xlab = "Large Consumer Flag")
#whether the customer has global offices
hist(treatment$Global.Flag, main = "Global Offices Flag Under Treatment", xlab = "Global Offices Flag")
hist(control$Global.Flag, main = "Global Offices Flag Under Control", xlab = "Global Offices Flag")
```